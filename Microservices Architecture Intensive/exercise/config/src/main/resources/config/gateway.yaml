server:
  port: ${PORT}

management:
  endpoints:
    web:
      exposure:
        include: gateway

spring:
  cloud:
    gateway:
      discovery:
        locator:
          enabled: true
      routes:
        - id: order
          uri: lb://order
          predicates:
            - Path=/products/*/orders/**
          filters:
            - name: CircuitBreaker
              args:
                name: order
                fallbackUri: forward:/fallback
        - id: product
          uri: lb://product
          predicates:
            - Path=/products/**
          filters:
            - name: CircuitBreaker
              args:
                name: product
                fallbackUri: forward:/fallback
      loadbalancer:
        ribbon:
          enabled: false

resilience4j.circuitbreaker:
  configs:
    default:
      slidingWindowSize: 20
      minimumNumberOfCalls: 5
      permittedNumberOfCallsInHalfOpenState: 3
      automaticTransitionFromOpenToHalfOpenEnabled: true
      waitDurationInOpenState: 2s
      failureRateThreshold: 50
      eventConsumerBufferSize: 10
      recordExceptions:
        - org.springframework.web.client.HttpServerErrorException
        - java.io.IOException
      ignoreExceptions:
        - java.lang.IllegalStateException
    shared:
      slidingWindowSize: 100
      permittedNumberOfCallsInHalfOpenState: 30
      waitDurationInOpenState: 1s
      failureRateThreshold: 50
      eventConsumerBufferSize: 10
      ignoreExceptions:
        - java.lang.IllegalStateException
  instances:
    product:
      baseConfig: default
    order:
      slidingWindowSize: 10
      minimumNumberOfCalls: 10
      permittedNumberOfCallsInHalfOpenState: 3
      waitDurationInOpenState: 1s
      failureRateThreshold: 50
      eventConsumerBufferSize: 10